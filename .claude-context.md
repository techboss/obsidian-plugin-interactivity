# Obsidian Interactivity Plugin - Claude Context

## Project Overview
A fork of the Obsidian Interactivity plugin that enables Python code execution directly within Obsidian notes. The plugin spawns a persistent Python subprocess and communicates with it via stdin/stdout.

## Recent Work Completed (Dec 2025)
Successfully implemented Phase 1 enhancements:

### Multi-line Block Support
- **Delimiter**: `%%%` marks start and end of executable blocks
- **Workflow**: Type `%%%`, enter content, type closing `%%%` + Enter to execute
- **Output**: Results appear AFTER the block (not inline)
- **Detection**: Uses odd/even delimiter counting to determine if cursor is on a closing delimiter

### JSON Communication Protocol
- TypeScript sends JSON messages to Python with:
  - `command`: The Python code to execute
  - `frontmatter`: Parsed YAML frontmatter from the note
  - `context`: `{ notePath, cursorLine, selectedText? }`
- Python globals available: `frontmatter`, `context`, `note_path`, `get_frontmatter()`

### Shortcut System with Smart Quoting
- Shortcuts defined as `trigger -> template` with `##param##` placeholder
- **Smart quote detection**: If template already has `"""##param##`, does simple replacement; otherwise wraps param in triple quotes
- Example shortcut: `@@ -> chat(r"""##param## """, system="...", model="gpt-5.1")`

### Chat Integration
- `chat.py` supports context-aware conversations with persistent memory
- Context files stored in `VAULT_CONTEXT_DIR` (e.g., `running-context.md`)
- Supports `@garmin` expansion via `obs_prompt_expand` module
- Functions: `chat()`, `chat4()`, `chat5()`, `clean_chat()`

## Key Files

### TypeScript (Plugin)
- **main.ts**: Main plugin file
  - `PythonMessage` interface for JSON protocol
  - `extractFrontmatter()` - YAML parsing
  - `findBlockAtCursor()` - Block detection (unused, kept for reference)
  - `applyShortcuts()` - Shortcut transformation with smart quoting
  - Enter key handler with delimiter counting logic
  - Settings: `blockDelimiter`, `useJsonProtocol`, `shortcuts`

### Python
- **py_manager.py**: Main Python entry point
  - `process_message()` - Parses JSON or plain text
  - `run_interactive_loop()` - Main input loop
  - Exposes globals: `frontmatter`, `context`, `note_path`

- **py_modules/chat.py**: ChatGPT integration
  - Graceful `openai` import with version check
  - Graceful `obs_prompt_expand` import for @garmin
  - Context-specific memory files (`chat_memory_<context>.json`)
  - Long-term context from markdown files

- **py_modules/plots.py**: Matplotlib plotting (graceful import)
- **py_modules/tables.py**: Pandas/tabulate tables (graceful import)

## User's Current Settings (data.json)
```json
{
  "shellExec": "/Users/anthony/Documents/Obsidian/Personal/.venv/bin/python",
  "shellParams": "-uq\n##plugin##py_manager.py\n",
  "shortcuts": "@@ -> chat(r\"\"\"##param## \"\"\", system=\"Be direct...\", save_context=True, model=\"gpt-5.1\")\n\n",
  "blockDelimiter": "%%%",
  "useJsonProtocol": true
}
```

## Architecture Decisions
1. **Block delimiter `%%%`**: Chosen for visibility and unlikely collision
2. **Odd/even counting**: Determines if delimiter is opening (even count above) or closing (odd count above)
3. **JSON protocol optional**: `useJsonProtocol` setting for backwards compatibility
4. **Graceful imports**: Python modules check for optional dependencies and provide helpful error messages
5. **Smart quoting**: Detects if template already has quotes to avoid double-quoting

## Deployment
```bash
# Build and deploy
npm run build
cp main.js /Users/anthony/Documents/Obsidian/Personal/.obsidian/plugins/interactivity/
cp py_manager.py /Users/anthony/Documents/Obsidian/Personal/.obsidian/plugins/interactivity/
cp -r py_modules /Users/anthony/Documents/Obsidian/Personal/.obsidian/plugins/interactivity/
```

## Git Status
- Branch: `main`
- Latest commit: `dc91a00` - "Add multi-line block support with JSON protocol and chat integration"
- 3 commits ahead of origin

## Potential Future Work
- Phase 2: Additional context passing (vault path, active file metadata)
- Phase 3: Bidirectional communication (Python requesting info from Obsidian)
- Error handling improvements
- Block syntax highlighting in editor
